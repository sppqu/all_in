@extends('layouts.coreui')

@section('title', 'Pembayaran Berlangganan - SPPQU')

@section('active_menu', 'menu.billing')

@section('content')
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-title-box">
                <div class="page-title-right">
                    <ol class="breadcrumb m-0">
                        <li class="breadcrumb-item"><a href="{{ route('manage.admin.dashboard') }}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{{ route('manage.subscription.plans') }}">Berlangganan</a></li>
                        <li class="breadcrumb-item active">Pembayaran</li>
                    </ol>
                </div>
                <h4 class="page-title">
                    <i class="fas fa-credit-card me-2"></i>
                    Pembayaran Berlangganan
                </h4>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Detail Pembayaran
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">Informasi Paket</h6>
                            <div class="mb-3">
                                <strong>Paket:</strong> {{ $plan['name'] }}
                            </div>
                            <div class="mb-3">
                                <strong>Harga:</strong> Rp {{ number_format($plan['price'], 0, ',', '.') }}
                            </div>
                            <div class="mb-3">
                                <strong>Durasi:</strong> {{ $plan['duration'] }} hari
                            </div>
                            <div class="mb-3">
                                <strong>Status:</strong> 
                                <span class="badge bg-warning text-dark">Menunggu Pembayaran</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">Metode Pembayaran</h6>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Pilih metode pembayaran yang tersedia di halaman Midtrans
                            </div>
                            <div class="mb-3">
                                <strong>Metode yang tersedia:</strong>
                                <ul class="list-unstyled mt-2">
                                    <li><i class="fas fa-credit-card text-primary me-2"></i>Kartu Kredit/Debit</li>
                                    <li><i class="fas fa-university text-success me-2"></i>Transfer Bank (BCA, BNI, BRI, Mandiri)</li>
                                    <li><i class="fas fa-wallet text-warning me-2"></i>E-Wallet (GoPay, OVO, DANA)</li>
                                    <li><i class="fas fa-store text-info me-2"></i>Minimarket (Indomaret, Alfamart)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="text-center">
                        <h6 class="text-primary mb-3">Lanjutkan ke Pembayaran</h6>
                        <p class="text-muted mb-4">
                            Klik tombol di bawah untuk melanjutkan ke halaman pembayaran Midtrans
                        </p>
                        
                        @if(isset($subscription) && $subscription->snap_token)
                            <button id="pay-button" class="btn btn-primary btn-lg">
                                <i class="fas fa-lock me-2"></i>
                                Bayar Sekarang
                            </button>
                        @else
                            <button class="btn btn-danger btn-lg" disabled>
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Error: Token pembayaran tidak tersedia
                            </button>
                            <div class="mt-3">
                                <p class="text-danger">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Silakan refresh halaman atau hubungi administrator
                                </p>
                            </div>
                        @endif
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-shield-alt me-1"></i>
                                Pembayaran aman dengan Midtrans
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Instructions -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Petunjuk Pembayaran
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-success">Setelah Pembayaran Berhasil:</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>Berlangganan akan aktif otomatis</li>
                                <li><i class="fas fa-check text-success me-2"></i>Email konfirmasi akan dikirim</li>
                                <li><i class="fas fa-check text-success me-2"></i>Akses ke semua fitur premium</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-warning">Jika Pembayaran Gagal:</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-exclamation-triangle text-warning me-2"></i>Coba metode pembayaran lain</li>
                                <li><i class="fas fa-exclamation-triangle text-warning me-2"></i>Hubungi support jika diperlukan</li>
                                <li><i class="fas fa-exclamation-triangle text-warning me-2"></i>Pembayaran dapat diulang</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Midtrans Script -->
<script src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="{{ config('midtrans.client_key') }}"></script>

<script>
// Check if Midtrans Snap is loaded
function checkMidtransLoaded() {
    if (typeof snap !== 'undefined') {
        return true;
    }
    return false;
}

document.getElementById('pay-button').addEventListener('click', function() {
    // Show loading state
    this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Memproses...';
    this.disabled = true;

    // Check if Midtrans is loaded
    if (!checkMidtransLoaded()) {
        console.error('Midtrans Snap not loaded. Please refresh the page.');
        this.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error: Midtrans tidak tersedia';
        this.disabled = false;
        return;
    }

    try {
        // Trigger Midtrans Snap
        @if(isset($subscription) && $subscription->snap_token)
        snap.pay('{{ $subscription->snap_token }}', {
            onSuccess: function(result) {
                console.log('Payment success:', result);
                window.location.href = '{{ route("manage.subscription.index") }}?status=success';
            },
            onPending: function(result) {
                console.log('Payment pending:', result);
                window.location.href = '{{ route("manage.subscription.index") }}?status=pending';
            },
            onError: function(result) {
                console.log('Payment error:', result);
                window.location.href = '{{ route("manage.subscription.index") }}?status=error';
            },
            onClose: function() {
                console.log('Payment popup closed');
                document.getElementById('pay-button').innerHTML = '<i class="fas fa-lock me-2"></i>Bayar Sekarang';
                document.getElementById('pay-button').disabled = false;
            }
        });
        @else
        console.error('Subscription or snap token not available');
        this.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error: Token pembayaran tidak tersedia';
        this.disabled = false;
        return;
        @endif
    } catch (error) {
        console.error('Error triggering Midtrans:', error);
        this.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error: Gagal memuat pembayaran';
        this.disabled = false;
    }
});

// Auto-trigger payment after 3 seconds (only if Midtrans is loaded)
setTimeout(function() {
    if (!document.getElementById('pay-button').disabled && checkMidtransLoaded()) {
        document.getElementById('pay-button').click();
    }
}, 3000);

// Add error handling for CSP issues
window.addEventListener('error', function(e) {
    if (e.message.includes('Content Security Policy') || e.message.includes('frame')) {
        console.warn('CSP Error detected. This might be related to Midtrans iframe.');
    }
});
</script>

<style>
.card {
    border-radius: 15px;
}

.card-header {
    border-radius: 15px 15px 0 0 !important;
}

.btn-lg {
    padding: 15px 30px;
    font-size: 1.1rem;
    font-weight: 600;
    border-radius: 10px;
}

.alert {
    border-radius: 10px;
}

.list-unstyled li {
    padding: 5px 0;
}
</style>
@endsection
